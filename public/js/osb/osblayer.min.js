/*
	OpenStreetBugs layer is free software: you can redistribute it
	and/or modify it under the terms of the GNU Affero General Public License
	as published by the Free Software Foundation, either version 3 of the
	License, or (at your option) any later version.

	This file is distributed in the hope that it will be useful, but
	WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
	or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public
	License <http://www.gnu.org/licenses/> for more details.

	Copyright © 2009–2010 Candid Dauth
*/

/**
 * A fully functional OpenStreetBugs layer. See http://openstreetbugs.schokokeks.org/.
 * Even though the OpenStreetBugs API originally does not intend this, you can create multiple instances of this Layer and add them to different maps (or to one single map for whatever crazy reason) without problems.
*/
OpenLayers.Layer.OpenStreetBugs=new OpenLayers.Class(OpenLayers.Layer.Markers,{serverURL:"http://openstreetbugs.schokokeks.org/api/0.1/",bugs:{},username:"NoName",iconOpen:new OpenLayers.Icon("http://openstreetbugs.schokokeks.org/client/open_bug_marker.png",new OpenLayers.Size(22,22),new OpenLayers.Pixel(-11,-11)),iconClosed:new OpenLayers.Icon("http://openstreetbugs.schokokeks.org/client/closed_bug_marker.png",new OpenLayers.Size(22,22),new OpenLayers.Pixel(-11,-11)),apiProjection:new OpenLayers.Projection("EPSG:4326"),readonly:false,reopenPopups:[],setCookie:true,cookieLifetime:1000,cookiePath:null,permalinkURL:"http://www.openstreetmap.org/",theme:"http://api.facilmap.org/osblayer/osblayer.css",initialize:function(a,j){OpenLayers.Layer.Markers.prototype.initialize.apply(this,[a,OpenLayers.Util.extend({opacity:0.7,projection:new OpenLayers.Projection("EPSG:4326")},j)]);putAJAXMarker.layers.push(this);this.events.addEventType("markerAdded");this.events.register("visibilitychanged",this,this.updatePopupVisibility);this.events.register("visibilitychanged",this,this.loadBugs);var h=document.cookie.split(/;\s*/);for(var e=0;e<h.length;e++){var c=h[e].split("=");if(c[0]=="osbUsername"){this.username=decodeURIComponent(c[1]);break}}if(this.theme){var d=true;var b=document.getElementsByTagName("link");for(var e=0,f=b.length;e<f;++e){if(OpenLayers.Util.isEquivalentUrl(b.item(e).href,this.theme)){d=false;break}}if(d){var g=document.createElement("link");g.setAttribute("rel","stylesheet");g.setAttribute("type","text/css");g.setAttribute("href",this.theme);document.getElementsByTagName("head")[0].appendChild(g)}}},afterAdd:function(){var a=OpenLayers.Layer.Markers.prototype.afterAdd.apply(this,arguments);this.map.events.register("moveend",this,this.loadBugs);this.loadBugs();return a},apiRequest:function(b){var a=document.createElement("script");a.type="text/javascript";a.src=this.serverURL+b+"&nocache="+(new Date()).getTime();document.body.appendChild(a)},updatePopupVisibility:function(){if(this.getVisibility()){for(var a=0;a<this.reopenPopups.length;a++){this.reopenPopups[a].show()}this.reopenPopups=[]}else{for(var a=0;a<this.markers.length;a++){if(this.markers[a].feature.popup&&this.markers[a].feature.popup.visible()){this.markers[a].feature.popup.hide();this.reopenPopups.push(this.markers[a].feature.popup)}}}},setUserName:function(e){if(this.username==e){return}this.username=e;if(this.setCookie){var d="osbUsername="+encodeURIComponent(e);if(this.cookieLifetime){d+=";expires="+(new Date((new Date()).getTime()+this.cookieLifetime*86400000)).toGMTString()}if(this.cookiePath){d+=";path="+this.cookiePath}document.cookie=d}for(var c=0;c<this.markers.length;c++){if(!this.markers[c].feature.popup){continue}var b=this.markers[c].feature.popup.contentDom.getElementsByTagName("input");for(var a=0;a<b.length;a++){if(b[a].className!="osbUsername"){continue}b[a].value=e}}},getUserName:function(){if(this.username){return this.username}else{return"NoName"}},loadBugs:function(){if(!this.getVisibility()){return true}var a=this.map.getExtent();if(!a){return false}a.transform(this.map.getProjectionObject(),this.apiProjection);this.apiRequest("getBugs?t="+this.round(a.top,5)+"&r="+this.round(a.right,5)+"&b="+this.round(a.bottom,5)+"&l="+this.round(a.left,5))},round:function(b,c){var a=Math.pow(10,c);return Math.round(b*a)/a},createMarker:function(f){if(this.bugs[f]){if(this.bugs[f].popup&&!this.bugs[f].popup.visible()){this.setPopupContent(f)}if(this.bugs[f].closed!=putAJAXMarker.bugs[f][2]){this.bugs[f].destroy()}else{return}}var d=putAJAXMarker.bugs[f][0].clone().transform(this.apiProjection,this.map.getProjectionObject());var e=putAJAXMarker.bugs[f][1];var b=putAJAXMarker.bugs[f][2];var c=new OpenLayers.Feature(this,d,{icon:(b?this.iconClosed:this.iconOpen).clone(),autoSize:true});c.popupClass=OpenLayers.Popup.FramedCloud.OpenStreetBugs;c.osbId=f;c.closed=b;var a=c.createMarker();a.feature=c;a.events.register("click",c,this.markerClick);a.events.register("mouseover",c,this.markerMouseOver);a.events.register("mouseout",c,this.markerMouseOut);this.addMarker(a);this.bugs[f]=c;this.events.triggerEvent("markerAdded")},setPopupContent:function(a){if(!this.bugs[a].popup){return}var e,d,c;var j=this;var l=document.createElement("div");e=document.createElement("h3");e.appendChild(document.createTextNode(closed?OpenLayers.i18n("Fixed Error"):OpenLayers.i18n("Unresolved Error")));e.appendChild(document.createTextNode(" ["));d=document.createElement("a");d.href="#";d.onclick=function(){j.map.setCenter(putAJAXMarker.bugs[a][0].clone().transform(j.apiProjection,j.map.getProjectionObject()),15)};d.appendChild(document.createTextNode(OpenLayers.i18n("Zoom")));e.appendChild(d);e.appendChild(document.createTextNode("]"));if(this.permalinkURL){e.appendChild(document.createTextNode(" ["));d=document.createElement("a");d.href=this.permalinkURL+(this.permalinkURL.indexOf("?")==-1?"?":"&")+"lon="+putAJAXMarker.bugs[a][0].lon+"&lat="+putAJAXMarker.bugs[a][0].lat+"&zoom=15";d.appendChild(document.createTextNode(OpenLayers.i18n("Permalink")));e.appendChild(d);e.appendChild(document.createTextNode("]"))}l.appendChild(e);var f=document.createElement("div");l.appendChild(f);var k=document.createElement("div");l.appendChild(k);var h=function(){f.style.display="block";k.style.display="none";j.bugs[a].popup.updateSize()};var m=function(){f.style.display="none";k.style.display="block";j.bugs[a].popup.updateSize()};h();e=document.createElement("dl");for(var g=0;g<putAJAXMarker.bugs[a][1].length;g++){d=document.createElement("dt");d.className=(g==0?"osb-description":"osb-comment");d.appendChild(document.createTextNode(g==0?OpenLayers.i18n("Description"):OpenLayers.i18n("Comment")));e.appendChild(d);d=document.createElement("dd");d.className=(g==0?"osb-description":"osb-comment");d.appendChild(document.createTextNode(putAJAXMarker.bugs[a][1][g]));e.appendChild(d)}f.appendChild(e);if(putAJAXMarker.bugs[a][2]){e=document.createElement("p");e.className="osb-fixed";d=document.createElement("em");d.appendChild(document.createTextNode(OpenLayers.i18n("Has been fixed.")));e.appendChild(d);f.appendChild(e)}else{if(!this.readonly){e=document.createElement("div");d=document.createElement("input");d.setAttribute("type","button");d.onclick=function(){m()};d.value=OpenLayers.i18n("Comment/Close");e.appendChild(d);f.appendChild(e);var n=document.createElement("form");n.onsubmit=function(){if(o.value.match(/^\s*$/)){return false}j.submitComment(a,o.value);j.hidePopup(a);return false};e=document.createElement("dl");d=document.createElement("dt");d.appendChild(document.createTextNode(OpenLayers.i18n("Nickname")));e.appendChild(d);d=document.createElement("dd");var b=document.createElement("input");b.value=this.username;b.className="osbUsername";b.onkeyup=function(){j.setUserName(b.value)};d.appendChild(b);e.appendChild(d);d=document.createElement("dt");d.appendChild(document.createTextNode(OpenLayers.i18n("Comment")));e.appendChild(d);d=document.createElement("dd");var o=document.createElement("input");d.appendChild(o);e.appendChild(d);n.appendChild(e);e=document.createElement("ul");e.className="buttons";d=document.createElement("li");c=document.createElement("input");c.setAttribute("type","submit");c.value=OpenLayers.i18n("Add comment");d.appendChild(c);e.appendChild(d);d=document.createElement("li");c=document.createElement("input");c.setAttribute("type","button");c.onclick=function(){this.form.onsubmit();j.closeBug(a);j.bugs[a].popup.hide();return false};c.value=OpenLayers.i18n("Mark as fixed");d.appendChild(c);e.appendChild(d);n.appendChild(e);k.appendChild(n);e=document.createElement("div");d=document.createElement("input");d.setAttribute("type","button");d.onclick=function(){h()};d.value=OpenLayers.i18n("Cancel");e.appendChild(d);k.appendChild(e)}}this.bugs[a].popup.setContentHTML(l)},createBug:function(b,a){this.apiRequest("addPOIexec?lat="+encodeURIComponent(b.lat)+"&lon="+encodeURIComponent(b.lon)+"&text="+encodeURIComponent(a+" ["+this.getUserName()+"]")+"&format=js")},submitComment:function(b,a){this.apiRequest("editPOIexec?id="+encodeURIComponent(b)+"&text="+encodeURIComponent(a+" ["+this.getUserName()+"]")+"&format=js")},closeBug:function(a){this.apiRequest("closePOIexec?id="+encodeURIComponent(a)+"&format=js")},resetPopupContent:function(a){if(!this.bugs[a].popup){return}this.bugs[a].popup.setContentHTML(document.createElement("div"))},showPopup:function(b){var a=null;if(!this.bugs[b].popup){a=this.bugs[b].createPopup(true);a.events.register("close",this,function(){this.resetPopupContent(b);if(this.bugs[b].osbClicked){this.bugs[b].osbClicked=false}})}else{if(this.bugs[b].popup.visible()){return}}this.setPopupContent(b);if(a){this.map.addPopup(a)}this.bugs[b].popup.show();this.bugs[b].popup.updateSize()},hidePopup:function(a){if(!this.bugs[a].popup||!this.bugs[a].popup.visible()){return}this.bugs[a].popup.hide();this.bugs[a].popup.events.triggerEvent("close")},markerClick:function(b){var a=this;a.osbClicked=!a.osbClicked;if(a.osbClicked){a.layer.showPopup(a.osbId)}else{a.layer.hidePopup(a.osbId)}OpenLayers.Event.stop(b)},markerMouseOver:function(b){var a=this;a.layer.showPopup(a.osbId);OpenLayers.Event.stop(b)},markerMouseOut:function(b){var a=this;if(!a.osbClicked){a.layer.hidePopup(a.osbId)}OpenLayers.Event.stop(b)},CLASS_NAME:"OpenLayers.Layer.OpenStreetBugs"});OpenLayers.Control.OpenStreetBugs=new OpenLayers.Class(OpenLayers.Control,{title:null,icon:new OpenLayers.Icon("http://openstreetbugs.schokokeks.org/client/icon_error_add.png",new OpenLayers.Size(22,22),new OpenLayers.Pixel(-11,-11)),osbLayer:null,initialize:function(b,a){this.osbLayer=b;this.title=OpenLayers.i18n("Create OpenStreetBug");OpenLayers.Control.prototype.initialize.apply(this,[a]);this.events.register("activate",this,function(){if(!this.osbLayer.getVisibility()){this.osbLayer.setVisibility(true)}});this.osbLayer.events.register("visibilitychanged",this,function(){if(this.active&&!this.osbLayer.getVisibility()){this.osbLayer.setVisibility(true)}})},destroy:function(){if(this.handler){this.handler.destroy()}this.handler=null;OpenLayers.Control.prototype.destroy.apply(this,arguments)},draw:function(){this.handler=new OpenLayers.Handler.Click(this,{click:this.click},{single:true,"double":false,pixelTolerance:0,stopSingle:false,stopDouble:false})},click:function(j){if(!this.map){return true}var g=this;var i=this.map.getLonLatFromViewPortPx(j.xy);var k=i.clone().transform(this.map.getProjectionObject(),this.osbLayer.apiProjection);var o=new OpenLayers.Feature(this.osbLayer,i,{icon:this.icon.clone(),autoSize:true});o.popupClass=OpenLayers.Popup.FramedCloud.OpenStreetBugs;var h=o.createMarker();h.feature=o;this.osbLayer.addMarker(h);var l=document.createElement("div");var f,d,c;f=document.createElement("h3");f.appendChild(document.createTextNode(OpenLayers.i18n("Create bug")));l.appendChild(f);var n=document.createElement("form");n.onsubmit=function(){g.osbLayer.createBug(k,m.value);h.feature=null;o.destroy();return false};f=document.createElement("dl");d=document.createElement("dt");d.appendChild(document.createTextNode(OpenLayers.i18n("Nickname")));f.appendChild(d);d=document.createElement("dd");var b=document.createElement("input");b.value=this.osbLayer.username;b.className="osbUsername";b.onkeyup=function(){g.osbLayer.setUserName(b.value)};d.appendChild(b);f.appendChild(d);d=document.createElement("dt");d.appendChild(document.createTextNode(OpenLayers.i18n("Bug description")));f.appendChild(d);d=document.createElement("dd");var m=document.createElement("input");d.appendChild(m);f.appendChild(d);n.appendChild(f);f=document.createElement("div");d=document.createElement("input");d.setAttribute("type","submit");d.value=OpenLayers.i18n("Create");f.appendChild(d);n.appendChild(f);l.appendChild(n);o.data.popupContentHTML=l;var a=o.createPopup(true);a.events.register("close",this,function(){o.destroy()});this.map.addPopup(a);a.updateSize()},CLASS_NAME:"OpenLayers.Control.OpenStreetBugs"});OpenLayers.Popup.FramedCloud.OpenStreetBugs=new OpenLayers.Class(OpenLayers.Popup.FramedCloud,{contentDom:null,autoSize:true,initialize:function(){this.displayClass=this.displayClass+" "+this.CLASS_NAME.replace("OpenLayers.","ol").replace(/\./g,"");var a=new Array(arguments.length);for(var b=0;b<arguments.length;b++){a[b]=arguments[b]}a[3]=null;var c=arguments[6];a[6]=function(d){if(c){c()}else{this.hide()}OpenLayers.Event.stop(d);this.events.triggerEvent("close")};OpenLayers.Popup.FramedCloud.prototype.initialize.apply(this,a);this.events.addEventType("close");this.setContentHTML(arguments[3])},setContentHTML:function(a){if(a!=null){this.contentDom=a}if(this.contentDiv==null||this.contentDom==null||this.contentDom==this.contentDiv.firstChild){return}while(this.contentDiv.firstChild){this.contentDiv.removeChild(this.contentDiv.firstChild)}this.contentDiv.appendChild(this.contentDom);if(this.autoSize){this.registerImageListeners();this.updateSize()}},destroy:function(){this.contentDom=null;OpenLayers.Popup.FramedCloud.prototype.destroy.apply(this,arguments)},CLASS_NAME:"OpenLayers.Popup.FramedCloud.OpenStreetBugs"});OpenLayers.i18n=OpenLayers.Lang.translate=function(b,a){var c=OpenLayers.Lang[OpenLayers.Lang.getCode()][b];if(!c){if(OpenLayers.Lang[OpenLayers.Lang.defaultCode][b]){c=OpenLayers.Lang[OpenLayers.Lang.defaultCode][b]}else{c=b}}if(a){c=OpenLayers.String.format(c,a)}return c};function putAJAXMarker(g,f,c,e,a){var d=e.split(/<hr \/>/);for(var b=0;b<d.length;b++){d[b]=d[b].replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")}putAJAXMarker.bugs[g]=[new OpenLayers.LonLat(f,c),d,a];for(var b=0;b<putAJAXMarker.layers.length;b++){putAJAXMarker.layers[b].createMarker(g)}}function osbResponse(a){if(a){alert("Error: "+a)}for(var b=0;b<putAJAXMarker.layers.length;b++){putAJAXMarker.layers[b].loadBugs()}}putAJAXMarker.layers=[];putAJAXMarker.bugs={};OpenLayers.Lang.en=OpenLayers.Util.extend(OpenLayers.Lang.en,{"Fixed Error":"Fixed Error","Unresolved Error":"Unresolved Error",Description:"Description",Comment:"Comment","Has been fixed.":"This error has been fixed already. However, it might take a couple of days before the map image is updated.","Comment/Close":"Comment/Close",Nickname:"Nickname","Add comment":"Add comment","Mark as fixed":"Mark as fixed",Cancel:"Cancel","Create OpenStreetBug":"Create OpenStreetBug","Create bug":"Create bug","Bug description":"Bug description",Create:"Create",Permalink:"Permalink",Zoom:"Zoom"});
